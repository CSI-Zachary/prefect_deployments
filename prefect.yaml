# Generic metadata about this project
name: Mover
prefect-version: 3.4.21

# 1. BUILD: Create the Docker image
build:
  - prefect_docker.deployments.steps.build_docker_image:
      id: build-image
      requires: prefect-docker>=0.3.0
      image_name: csizachary/prefect-mover
      tag: latest
      dockerfile: auto # uses the Dockerfile we created

# 2. PUSH: Upload the image to Docker Hub
push:
  - prefect_docker.deployments.steps.push_docker_image:
      requires: prefect-docker>=0.3.0
      image_name: "{{ build-image.image_name }}"
      tag: "{{ build-image.tag }}"

# 3. PULL: We don't need Git anymore because the code is BAKED into the image!
pull:
  - prefect.deployments.steps.set_working_directory:
      directory: /opt/prefect

deployments:
  - name: mover
    version: null
    tags: []
    description: "Moves files based on logic"
    schedule: {}
    flow_name: mover
    entrypoint: mover.py:mover
    parameters: {}
    work_pool:
      name: mover_docker_pool
      work_queue_name: default
      # We tell the worker to use the image we just built
      job_variables:
        image: "{{ build-image.image }}"